---
layout: post
title: ğŸ¥³ è¾¹å­¦è¾¹ç©ï¼ŒFlutter åˆ¶ä½œ 2048 æ¸¸æˆ
date: 2021-10-26
categories: æŠ€æœ¯
tags: ["Flutter"]
---

### å‰è¨€

æœ€è¿‘åœ¨å­¦ä¹  Flutter çš„ä¸€äº›çŸ¥è¯†ï¼Œæƒ³ç€ç‹¬ç«‹å†™ä¸€ä¸ªå°ç¤ºä¾‹æ¥è¿ç”¨ä¸€ä¸‹æ‰€å­¦çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™ä¸ªFlutter ç‰ˆæœ¬ 2048 å°æ¸¸æˆçš„é¡¹ç›®ã€‚å®Œæ•´ä»£ç è¯·æˆ³ [Github](https://github.com/owenleexiaoyu/FlutterCodeLabs/blob/main/flutter_games/lib/games/2048/game_2048_page.dart)ã€‚

2048 å°æ¸¸æˆæ›¾ç»ä¹Ÿæ˜¯é£é¡ä¸€æ—¶ï¼Œåº”è¯¥å¾ˆå¤šäººéƒ½ç©è¿‡ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯ç®€å•è¯´ä¸€ä¸‹è¿™ä¸ªæ¸¸æˆçš„æœºåˆ¶ï¼Œè¿™é‡Œæœ‰ä¸ªç½‘é¡µç‰ˆçš„ [2048](https://play2048.co/)ï¼Œå¤§å®¶å¯ä»¥å®é™…ä½“éªŒä¸€ä¸‹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ª 4 * 4 çš„æ£‹ç›˜ï¼Œå…±æœ‰ 16 ä¸ªå°å—ï¼Œæ¯ä¸ªå°å—ä¸­ï¼Œè¦ä¹ˆæ˜¯ç©ºçš„ï¼Œè¦ä¹ˆæœ‰ä¸€ä¸ªæ•°å­—ï¼Œç©å®¶å¯ä»¥ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘å»æ»‘åŠ¨ï¼ˆæˆ–è€…é€šè¿‡é”®ç›˜æ–¹å‘é”®æ§åˆ¶ï¼‰ã€‚å½“å·¦å³æ»‘åŠ¨æ—¶ï¼ŒåŒä¸€è¡Œä¸Šæ•°å­—å°å—ä¼šè¢«ç§»åˆ°æœ€å·¦ç«¯æˆ–è€…æœ€å³ç«¯ï¼Œä¸­é—´æ²¡æœ‰ç©ºæ ¼ï¼Œç›¸é‚»çš„ç›¸åŒæ•°å­—çš„å°å—åˆå¹¶æˆä¸€ä¸ªï¼Œæ•°å­—æ˜¯ä¹‹å‰æ ¼å­çš„ä¸¤å€ï¼Œæ¯”å¦‚ 2 å’Œ 2 ä¼šåˆå¹¶æˆ 4 å’Œ ç©ºæ ¼ã€‚æ¯æ¬¡æ»‘åŠ¨åæœ‰æ ¼å­ç§»åŠ¨æ—¶ï¼Œå°±ä¼šåœ¨æ£‹ç›˜çš„ç©ºçš„å°å—é‡Œéšæœºç”Ÿæˆä¸€ä¸ªæ•°å­—ã€‚æ¸¸æˆçš„ç›®æ ‡æ˜¯åˆå¹¶å‡º 2048 è¿™ä¸ªæ•°å­—ã€‚

å¥½çš„ï¼Œä»‹ç»å®Œè¿™ä¸ªæ¸¸æˆæ€ä¹ˆç©åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›å…¥æ­£é¢˜ï¼Œå¼€å§‹å®ç°æˆ‘ä»¬ Flutter ç‰ˆæœ¬çš„ 2048 äº†ã€‚

æˆ‘ä»¬æœ€ç»ˆå®ç°çš„æ•ˆæœå¦‚ä¸‹ï¼Œè¿˜åŸåº¦æ˜¯ä¸æ˜¯è¿˜å¯ä»¥ï¼Ÿ

![](https://s2.loli.net/2022/05/24/4esEvRHt7KhW2AO.gif#crop=0&crop=0&crop=1&crop=1&height=640&id=tjBIW&originHeight=1280&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=288)

### UI ç•Œé¢

é¦–å…ˆæˆ‘ä»¬å…ˆæ¥ç”»ä¸€ä¸‹ç•Œé¢ã€‚ä»ä¸Šé¢çš„æ•ˆæœå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ¸¸æˆç•Œé¢å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ä¸Šæ–¹çš„æ ‡é¢˜ã€åˆ†æ•°ã€å†å²æœ€é«˜åˆ†ã€é‡æ–°å¼€å§‹æ¸¸æˆæŒ‰é’®ç­‰å…ƒç´ ï¼š

![](https://s2.loli.net/2022/05/24/vgZct6hJOCBnsLK.png#crop=0&crop=0&crop=1&crop=1&height=216&id=G8xwk&originHeight=432&originWidth=728&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=364)

ä¸€ä¸ªæ˜¯ä¸‹æ–¹çš„æ£‹ç›˜éƒ¨åˆ†ï¼Œæœ‰ 4 * 4 ä¸ªå°æ ¼å­ï¼š

![](https://s2.loli.net/2022/05/24/iPhbHBaGsekR82M.png#crop=0&crop=0&crop=1&crop=1&height=371&id=KTCf5&originHeight=742&originWidth=712&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=356)

å¦‚æœæ¸¸æˆç»“æŸæ—¶ï¼Œè¿™éƒ¨åˆ†ä¸Šé¢è¿˜ä¼šç›–æœ‰ä¸€ä¸ªæ¸¸æˆç»“æŸçš„è’™å±‚ï¼š

![](https://s2.loli.net/2022/05/24/q9kVh5bGfwJytMz.png#crop=0&crop=0&crop=1&crop=1&height=353&id=LOc5e&originHeight=706&originWidth=698&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=349)

æ¸¸æˆæ•´ä½“ UI çš„ä»£ç ï¼Œç²¾ç®€ä¸€ä¸‹æ˜¯è¿™æ ·çš„ï¼š

```dart
class Game2048Page extends StatefulWidget {
  @override
  _Game2048PageState createState() => _Game2048PageState();
}

class _Game2048PageState extends State<Game2048Page> {

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      extendBodyBehindAppBar: true,
      body: Container(
        padding: EdgeInsets.only(top: 30),
        color: GameColors.bgColor1,
        child: Column(
          children: [
            Flexible(child: gameHeader()),
            Flexible(flex: 2,child: Game2048Panel())
          ],
        )
      ),
    );
  }

  // çœç•¥äº†ä»£ç 
  Widget gameHeader() {
    return Container();
  }
}
```

å› ä¸ºç•Œé¢é‡Œéœ€è¦å±•ç¤ºå˜åŒ–çš„å½“å‰åˆ†æ•°å’Œå†å²æœ€é«˜åˆ†æ•°ï¼Œæ‰€ä»¥ `Game2048Page` æ˜¯ç»§æ‰¿è‡ª `StatefulWidget`ã€‚å¸ƒå±€ç»“æ„æ•´ä½“æ˜¯ä¸€ä¸ª Column çš„å‚ç›´æ–¹å‘å¸ƒå±€ï¼Œä¸Šé¢æ˜¯ `gameHeader()`ï¼ŒæŠ½æˆäº†ä¸€ä¸ªæ–¹æ³•ï¼Œé‡Œé¢å°±æ˜¯æ ‡é¢˜ã€æè¿°ã€åˆ†æ•°ç­‰ä¿¡æ¯ï¼Œä¸‹é¢æ˜¯ `Game2048Panel` è¡¨ç¤ºæ£‹ç›˜ï¼Œå®šä¹‰æˆäº†ä¸€ä¸ª Widgetï¼ŒHeader å’Œ Panel æ˜¯ 1 ï¼š2 çš„é«˜åº¦æ¯”ä¾‹ï¼ˆè¿™ä¸ªåé¢ä¼šæåˆ°æ˜¯å¹²å˜›çš„ï¼‰ã€‚

#### Header éƒ¨åˆ†

Header éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå°±ç²—ç•¥ä»‹ç»ä¸€ä¸‹ã€‚æˆ‘ä»¬éœ€è¦å±•ç¤ºå½“å‰çš„åˆ†æ•°å’Œå†å²æœ€é«˜åˆ†ï¼Œæ‰€ä»¥åœ¨ `_Game2048PageState` ä¸­å®šä¹‰ä¸¤ä¸ªå˜é‡ï¼Œå¹¶åœ¨ç›¸åº”çš„ UI å…ƒç´ ä¸­å±•ç¤ºå‡ºæ¥ï¼Œåˆ†æ•°ä¸‹æ–¹è¿˜æœ‰ä¸ª New Game çš„æŒ‰é’®ï¼Œç‚¹å‡»æŒ‰é’®å¯ä»¥é‡æ–°å¼€å§‹æ¸¸æˆã€‚è¿™éƒ¨åˆ† UI ä»£ç ç²¾ç®€åæ˜¯è¿™æ ·çš„ï¼Œæ›´æ–°åˆ†æ•°å’Œé‡æ–°å¼€å§‹æ¸¸æˆçš„é€»è¾‘æˆ‘ä»¬åé¢å†å®ç°ã€‚

```dart
class _Game2048PageState extends State<Game2048Page> {

  /// å½“å‰åˆ†æ•°
  int currentScore = 0;
  /// å†å²æœ€é«˜åˆ†
  int highestScore = 0;
 
  Widget gameHeader() {
  	return Row(
    	children: [
        Text("2048"),
        Column(
          children: [
            Text(currentScore.toString()),
            Text(highestScore.toString()),
            ElevatedButton(
            	onPressed: () {
                // é‡æ–°å¼€å§‹æ¸¸æˆï¼Œè¿™é‡Œçš„é€»è¾‘ä¹‹åå†å®ç°
              },
              child: Text("New Game"),
            )
          ]
        ),
      ]
    )
  }
}
```

#### Panel éƒ¨åˆ†

Panel éƒ¨åˆ†è¢«å®šä¹‰æˆäº†ä¸€ä¸ªå«åš `Game2048Panel` çš„ Widgetï¼Œç»§æ‰¿è‡ª StatefulWidgetï¼Œå› ä¸ºå†…éƒ¨æœ‰æ˜¯å¦æ¸¸æˆç»“æŸç­‰çŠ¶æ€ã€‚UI éƒ¨åˆ†ï¼Œå½“æ¸¸æˆç»“æŸæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ Stack å¸ƒå±€ï¼Œè’™å±‚ç›–åœ¨æ£‹ç›˜çš„ä¸Šæ–¹ï¼Œæ¸¸æˆæ²¡æœ‰ç»“æŸæ—¶ï¼Œåªæœ‰æ£‹ç›˜ã€‚æ£‹ç›˜å®½é«˜æ¯”æ˜¯ 1 : 1ï¼Œä½¿ç”¨ AspectRatio ç»„ä»¶ï¼Œæ£‹ç›˜å¯ä»¥è¯†åˆ«ç”¨æˆ·ä¸Šä¸‹å·¦å³æ»‘åŠ¨çš„æ‰‹åŠ¿ï¼Œæ‰€ä»¥éœ€è¦ GestureDetector ç»„ä»¶ï¼Œæ£‹ç›˜ä¸­ 4 * 4 çš„å°æ ¼å­ï¼Œç”¨ GridView æ¥å®ç°ã€‚`Game2048Panel` çš„ UI ç»“æ„å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://s2.loli.net/2022/05/24/Kn9HbNZjVAPT8h6.png#crop=0&crop=0&crop=1&crop=1&height=416&id=N6NX9&originHeight=832&originWidth=1150&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=575)

è¿™éƒ¨åˆ†æ•´ä½“çš„ä»£ç ç²¾ç®€ä¸€ä¸‹ï¼ˆå»æ‰äº† UI ç»†èŠ‚ï¼‰æ˜¯è¿™æ ·çš„ï¼š

```dart
import 'dart:math';

import 'package:flutter/material.dart';
import 'package:flutter_games/games/2048/game_colors.dart';

class Game2048Panel extends StatefulWidget {
  final ValueChanged<int>? onScoreChanged;

  Game2048Panel({Key? key, this.onScoreChanged}) : super(key: key);

  @override
  Game2048PanelState createState() => Game2048PanelState();
}

class Game2048PanelState extends State<Game2048Panel> {
  /// æ¯è¡Œæ¯åˆ—çš„ä¸ªæ•°
  static const int SIZE = 4;

  /// åˆ¤æ–­æ˜¯å¦æ¸¸æˆç»“æŸ
  bool _isGameOver = false;

  @override
  Widget build(BuildContext context) {
    if (_isGameOver) {
      return Stack(
        children: [
          _buildGamePanel(context),
          _buildGameOverMask(context),
        ],
      );
    } else {
      return _buildGamePanel(context);
    }
  }

  Widget _buildGamePanel(BuildContext context) {
    return GestureDetector(
      child: AspectRatio(
        aspectRatio: 1.0,
        child: Container(
          child: MediaQuery.removePadding(
            /// GridView é»˜è®¤é¡¶éƒ¨ä¼šæœ‰ paddingï¼Œé€šè¿‡è¿™ä¸ªåˆ é™¤é¡¶éƒ¨ padding
            removeTop: true,
            context: context,
            child: GridView.builder(
              /// ç¦ç”¨ GridView çš„æ»‘åŠ¨
              physics: const NeverScrollableScrollPhysics(),
              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: SIZE,
              ),
              itemCount: SIZE * SIZE,
              itemBuilder: (context, int index) {
                return _buildGameCell(0);
              },
            ),
          ),
        ),
      ),
    );
  }

  /// GridView ä¸­çš„å­ç»„ä»¶ï¼Œè¡¨ç¤ºæ¯ä¸ªå°å—
  Widget _buildGameCell(int value) {
    return Text(
      value == 0 ? "" : value.toString(),
    );
  }

  /// æ¸¸æˆç»“æŸæ—¶ç›–åœ¨ Panel ä¸Šçš„è’™å±‚
  Widget _buildGameOverMask(BuildContext context) {
    return AspectRatio(
        aspectRatio: 1.0,
        child: Center(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text("Game Over"),
              ElevatedButton(
                  onPressed: () {
                    // é‡æ–°å¼€å§‹æ¸¸æˆ
                  },
                  child: Text("ReStart"))
            ],
          ),
        ));
  }
}
```

è¿™é‡Œæœ‰å‡ ä¸ªå°ç»†èŠ‚å¯ä»¥è¯´ä¸€ä¸‹ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨ GridView çš„æ—¶å€™ï¼Œé¡¶éƒ¨é»˜è®¤ä¼šæœ‰ä¸€ä¸ª Paddingï¼Œè¿™æ ·ä¼šå½±å“æœ€åå±•ç¤ºçš„æ•ˆæœï¼Œæ‰€ä»¥è¿™é‡Œç”¨ `MediaQuery.removePadding()` ç»„ä»¶åŒ…è£¹äº† GridViewï¼Œå¹¶ä¸”è®¾ç½® `removeTop` ä¸º trueï¼Œå°±å¯ä»¥å»æ‰è¿™éƒ¨åˆ†çš„ paddingã€‚ç¬¬äºŒä¸ªæ˜¯é»˜è®¤ GridView æ˜¯å¯ä»¥æ»šåŠ¨çš„ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒæ»šåŠ¨ï¼Œæ‰€ä»¥ç»™ GridView çš„ `physics` å±æ€§è®¾ç½®ä¸º `NeverScrollableScrollPhysics`ï¼Œç¦ç”¨äº†å®ƒçš„æ»šåŠ¨ã€‚

åˆ°è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„å»ºå‡ºå¦‚ä¸‹æ‰€ç¤ºçš„ UI ç•Œé¢ï¼š

![](https://s2.loli.net/2022/05/24/4tYUv5A8X2unrGi.png#crop=0&crop=0&crop=1&crop=1&height=634&id=GpyKq&originHeight=2532&originWidth=1170&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=293)

### æ¸¸æˆé€»è¾‘

æ„å»ºå¥½åŸºç¡€çš„ UIï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä¸€æ­¥æ­¥ç¼–å†™é€»è¾‘å®ç°äº†ã€‚

#### æ•°æ®æºåŠæ¸¸æˆåˆå§‹åŒ–

é¦–å…ˆæˆ‘ä»¬å…ˆæ¥æ„é€ è¿™ä¸ªæ¸¸æˆçš„æ•°æ®æºï¼Œ4 * 4 çš„æ£‹ç›˜ï¼Œæ£‹ç›˜ä¸­æ¯ä¸ªæ ¼å­è¦ä¹ˆæ˜¯ç©ºçš„ï¼Œè¦ä¹ˆæ˜¯æ•°å­—ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½æƒ³åˆ°ç”¨ä¸€ä¸ª int çš„äºŒç»´æ•°ç»„æ¥è¡¨ç¤ºå®ƒï¼Œç©ºæ ¼å­æˆ‘ä»¬ç”¨ 0 æ¥è¡¨ç¤ºã€‚ä¹Ÿå°±æ˜¯ä¸‹é¢ä»£ç é‡Œçš„ `_gameMap`ã€‚

```dart
// Game2048Panel
// æ•°æ®æºï¼Œç±»å‹æ˜¯ List<List<int>>
List _gameMap = List.generate(SIZE, (_) => List<int>.generate(SIZE, (_) => 0));
```

åœ¨å°æ ¼å­ Cell ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å°† GridView çš„ index è½¬åŒ–ä¸ºäºŒç»´æ•°ç»„çš„åæ ‡ï¼Œä» _gameMap ä¸­å–å‡ºæ•°æ®æ˜¾ç¤ºåœ¨ Cell ä¸­ã€‚

```dart
GridView.builder(
  itemCount: SIZE * SIZE,
  itemBuilder: (context, int index) {
    int indexI = index ~/ SIZE;
    int indexJ = index % SIZE;
    return _buildGameCell(_gameMap[indexI][indexJ]);
  },
),
```

```dart
Widget _buildGameCell(int value) {
  return Container(
    decoration: BoxDecoration(
      color: GameColors.mapValueToColor(value),  // æ•°å€¼å’ŒèƒŒæ™¯é¢œè‰²æœ‰ä¸ªæ˜ å°„
      borderRadius: BorderRadius.circular(5),
    ),
    child: Center(
      child: Text(
        value == 0 ? "" : value.toString(), // å¦‚æœæ•°å­—æ˜¯0ï¼Œå±•ç¤ºç©ºå­—ç¬¦ä¸²ï¼Œæ•ˆæœä¸Šå°±æ˜¯ç©ºæ ¼ï¼Œå¦åˆ™å±•ç¤ºæ•°å­—
      ),
    ),
  );
}
```

è¿™æ ·æˆ‘ä»¬æ•°æ®çš„å±•ç¤ºå°±å®Œæˆäº†ã€‚å› ä¸ºä¸€å¼€å§‹ _gameMap ä¸­éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥è¿™æ­¥å®Œæˆåï¼Œæ£‹ç›˜é‡Œéƒ½æ˜¯ç©ºæ ¼ï¼Œæˆ‘ä»¬å¯ä»¥ Mock ä¸€äº›æ•°æ®ï¼Œçœ‹çœ‹å®é™…æ˜¾ç¤ºæ•ˆæœã€‚è¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªåœ¨ _gameMap ä¸­éšæœºåæ ‡ç”Ÿæˆä¸€ä¸ªé 0 æ•°å­—çš„å‡½æ•° `_randomNewCellData`ï¼š

```dart
/// åœ¨ gameMap é‡Œéšæœºä½ç½®æ”¾ç½®æŒ‡å®šçš„æ•°å­—ï¼Œ
/// éœ€è¦åˆ·æ–°ç•Œé¢æ—¶ï¼Œéœ€è¦å°†è¿™ä¸ªå‡½æ•°æ”¾åœ¨ setState é‡Œ
void _randomNewCellData(int data) {
  /// åœ¨äº§ç”Ÿæ–°çš„æ•°å­—ï¼ˆå—ï¼‰æ—¶ï¼Œ
  /// éœ€è¦å…ˆåˆ¤æ–­ä¸‹æ˜¯å¦mapä¸­æ‰€æœ‰çš„æ•°å­—éƒ½ä¸ä¸º0
  /// å¦‚æœéƒ½ä¸ä¸º0ï¼Œå°±ç›´æ¥returnï¼Œä¸äº§ç”Ÿæ–°æ•°å­—
  if (isGameMapAllNotZero()) {
    debugPrint("gameMapä¸­éƒ½ä¸æ˜¯0ï¼Œä¸èƒ½ç”Ÿæˆ");
    return;
  }
  while (true) {
    Random random = Random();
    int randomI = random.nextInt(SIZE);
    int randomJ = random.nextInt(SIZE);
    if (_gameMap[randomI][randomJ] == 0) {
      _gameMap[randomI][randomJ] = data;
      break;
    }
  }
}

/// åˆ¤æ–­Mapä¸­çš„æ•°å­—æ˜¯å¦éƒ½ä¸ä¸º0
bool isGameMapAllNotZero() {
  bool isAllNotZero = true;
  for (int i = 0; i < SIZE; i++) {
    for (int j = 0; j < SIZE; j++) {
      if (_gameMap[i][j] == 0) {
        isAllNotZero = false;
        break;
      }
    }
  }
  return isAllNotZero;
}
```

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„éšæœºç®—æ³•ï¼Œåˆ¤æ–­ _gameMap ä¸­çš„æ•°æ˜¯å¦éƒ½ä¸ä¸º 0ï¼Œå¦‚æœéƒ½ä¸ä¸º 0ï¼Œåˆ™è¿”å›ï¼›å¦åˆ™å°±éšæœºç”Ÿæˆä¸€ç»„è¡Œåˆ—åæ ‡ï¼Œå¦‚æœè¿™ä¸ªåæ ‡ä¸Šçš„æ•°æ˜¯ 0ï¼Œå°±ç»™è¿™ä¸ªåæ ‡èµ‹ä¸€ä¸ªé 0 å€¼ï¼Œå¦‚æœè¿™ä¸ªåæ ‡ä¸Šçš„æ•°ä¸æ˜¯ 0ï¼Œåˆ™ç»§ç»­éšæœºç”Ÿæˆä¸€ç»„åæ ‡ï¼Œç›´åˆ°ç”Ÿæˆåæ ‡ä¸Šçš„æ•°æ˜¯ 0 ä¸ºæ­¢ã€‚

ç„¶ååœ¨ `initState` è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥åˆå§‹åŒ–æ¸¸æˆæ•°æ®å•¦ï¼Œæˆ‘ä»¬é»˜è®¤éšæœºç”Ÿæˆä¸€ä¸ª 2 å’Œä¸€ä¸ª 4ã€‚

```dart
@override
void initState() {
  super.initState();
  _initGameMap();
}

/// åˆå§‹åŒ–æ•°æ®
void _initGameMap() {
  /// æ‰§è¡Œä¸¤æ¬¡éšæœº
  _randomNewCellData(2);
  _randomNewCellData(4);
}
```

ç°åœ¨è¿è¡Œç¨‹åºï¼Œå°±å¯ä»¥çœ‹åˆ°éšæœºæ”¾ç½®æ•°å­—å°å—çš„æ•ˆæœå•¦ï¼š

![](https://s2.loli.net/2022/05/24/iPhbHBaGsekR82M.png#crop=0&crop=0&crop=1&crop=1&height=371&id=d4wYY&originHeight=742&originWidth=712&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=356)

#### æ»‘åŠ¨æ‰‹åŠ¿è¯†åˆ«

æ¥ä¸‹æ¥éå¸¸é‡è¦çš„ä¸€æ­¥å°±æ˜¯è¦è¯†åˆ«ç”¨æˆ·ä¸Šä¸‹å·¦å³æ»‘åŠ¨çš„æ‰‹åŠ¿ï¼Œå› ä¸ºå¯¹ `GestureDetector` çš„ API ä¸äº†è§£ï¼Œä¸ç¡®å®šæ˜¯å¦æœ‰æ›´ç®€å•çš„åšæ³•ï¼Œæˆ‘è¿™é‡Œçš„å®ç°æ–¹å¼å’Œ Android çš„æ‰‹åŠ¿è¯†åˆ«æ¯”è¾ƒæ¥è¿‘ï¼Œåœ¨ `onPanDown` æ—¶ï¼Œè®°å½•ä¸‹æ‰‹æŒ‡çš„ä¸‹è½åæ ‡ï¼Œåœ¨ `onPanUpdate` é‡Œï¼Œè®°å½•ä¸‹å½“å‰çš„åæ ‡ã€‚ä¸ºäº†è¿‡æ»¤æ‰æ–œå‘çš„æ»‘åŠ¨ï¼Œè¿™é‡Œå®šä¹‰äº†ä¸¤ä¸ªé˜ˆå€¼ï¼š**ä¸»æ–¹å‘çš„æœ€å°æ»‘åŠ¨è·ç¦»** å’Œ **äº¤å‰æ–¹å‘ä¸Šçš„æœ€å¤§æ»‘åŠ¨è·ç¦»**ã€‚å¦‚æœå½“å‰åæ ‡ - ä¸‹è½åæ ‡åœ¨æ°´å¹³æ–¹å‘çš„è·ç¦» > ä¸»æ–¹å‘æœ€å°æ»‘åŠ¨è·ç¦»ï¼Œå¹¶ä¸”å½“å‰åæ ‡ - ä¸‹è½åæ ‡åœ¨å‚ç›´æ–¹å‘çš„è·ç¦» < äº¤å‰æ–¹å‘æœ€å¤§æ»‘åŠ¨è·ç¦»ï¼Œå°±è¡¨ç¤ºæ˜¯æ°´å¹³æ–¹å‘çš„æ»‘åŠ¨ã€‚åè¿‡æ¥åˆ™æ˜¯å‚ç›´æ–¹å‘çš„æ»‘åŠ¨ï¼Œå†æ¯”è¾ƒåœ¨ä¸»è½´æ–¹å‘ä¸Šå½“å‰åæ ‡å’Œä¸‹è½åæ ‡çš„å¤§å°ï¼Œå¯ä»¥è¿›ä¸€æ­¥åˆ¤æ–­å‡ºæ˜¯å‘å·¦æ»‘åŠ¨è¿˜æ˜¯å‘å³æ»‘åŠ¨ï¼ˆå‘ä¸Šæ»‘åŠ¨è¿˜æ˜¯å‘ä¸‹æ»‘åŠ¨ï¼‰ã€‚

```dart
/// å½“ä¸Šä¸‹æ»‘åŠ¨æ—¶ï¼Œå·¦å³æ–¹å‘çš„åç§»åº”è¯¥å°äºè¿™ä¸ªé˜ˆå€¼ï¼Œå·¦å³æ»‘åŠ¨äº¦ç„¶
double _crossAxisMaxLimit = 20.0;

/// å½“ä¸Šä¸‹æ»‘åŠ¨æ—¶ï¼Œä¸Šä¸‹æ–¹å‘çš„åç§»åº”è¯¥å¤§äºè¿™ä¸ªé˜ˆå€¼ï¼Œå·¦å³æ»‘åŠ¨äº¦ç„¶
double _mainAxisMinLimit = 60.0;

/// onPanUpdate ä¼šå›è°ƒå¤šæ¬¡ï¼Œåªéœ€è¦ç¬¬ä¸€æ¬¡æœ‰æ•ˆçš„å°±å¯ä»¥äº†ï¼Œ
/// åœ¨ onPanDown æ—¶è®¾ä¸º trueï¼Œç¬¬ä¸€æ¬¡æœ‰æ•ˆæ»‘åŠ¨åï¼Œè®¾ä¸º false
bool _firstValidPan = true;

GestureDetector(
  onPanDown: (DragDownDetails details) {
    lastPosition = details.globalPosition;
    _firstValidPan = true;
  },
  onPanUpdate: (DragUpdateDetails details) {
    final currentPosition = details.globalPosition;

    /// é¦–å…ˆåŒºåˆ†æ˜¯å‚ç›´æ–¹å‘è¿˜æ˜¯æ°´å¹³æ–¹å‘æ»‘åŠ¨
    if ((currentPosition.dx - lastPosition.dx).abs() > _mainAxisMinLimit &&
        (currentPosition.dy - lastPosition.dy).abs() < _crossAxisMaxLimit) {
      // æ°´å¹³æ–¹å‘æ»‘åŠ¨
      if (_firstValidPan) {
        debugPrint("æ°´å¹³æ–¹å‘æ»‘åŠ¨");
        /// ç„¶ååŒºåˆ†æ˜¯å‘å·¦æ»‘è¿˜æ˜¯å‘å³æ»‘
        if (currentPosition.dx - lastPosition.dx > 0) {
          // å‘å³æ»‘
          debugPrint("å‘å³æ»‘");
        } else {
          // å‘å·¦æ»‘
          debugPrint("å‘å·¦æ»‘");
        }
        _firstValidPan = false;
      }
    } else if ((currentPosition.dy - lastPosition.dy).abs() > _mainAxisMinLimit &&
        (currentPosition.dx - lastPosition.dx).abs() < _crossAxisMaxLimit) {
      // å‚ç›´æ–¹å‘æ»‘åŠ¨
      if (_firstValidPan) {
        debugPrint("å‚ç›´æ–¹å‘æ»‘åŠ¨");
        /// ç„¶ååŒºåˆ†æ˜¯å‘ä¸Šæ»‘è¿˜æ˜¯å‘ä¸‹æ»‘
        if (currentPosition.dy - lastPosition.dy > 0) {
          // å‘ä¸‹æ»‘
          debugPrint("å‘ä¸‹æ»‘");
        } else {
          // å‘ä¸Šæ»‘
          debugPrint("å‘ä¸Šæ»‘");
        }
        _firstValidPan = false;
      }
    }
  },
}
```

è¿™æ®µä»£ç é‡Œè¿˜æœ‰ä¸€ä¸ªå˜é‡ `_firstValidPan` éœ€è¦è§£é‡Šä¸‹ï¼Œå› ä¸º `onPanUpdate` åœ¨æ‰‹æŒ‡æ»‘åŠ¨è¿‡ç¨‹ä¸­ä¼šä¸€ç›´å›è°ƒï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è¯†åˆ«åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„æ»‘åŠ¨ï¼ˆåˆ¤æ–­å‡ºæ˜ç¡®çš„æ–¹å‘ï¼‰æ—¶ï¼Œåç»­çš„ onPanUpdate å°±ä¸éœ€è¦å¤„ç†äº†ï¼Œéœ€è¦åœ¨ onPanDown ä¸­é‡ç½®è¿™ä¸ªå˜é‡ã€‚

ç°åœ¨è¿è¡Œä»£ç ï¼Œæˆ‘ä»¬åœ¨æ£‹ç›˜é‡Œç”¨æ‰‹æŒ‡ä¸Šä¸‹å·¦å³æ»‘åŠ¨ï¼Œå¯ä»¥æ‰“å°å‡ºæ­£ç¡®çš„æ‰‹åŠ¿æ»‘åŠ¨æ–¹å‘ã€‚

#### æ•°å­—å—çš„ç§»åŠ¨ä¸åˆå¹¶

å®Œæˆæ‰‹åŠ¿è¯†åˆ«åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ•°å­—å—çš„ç§»åŠ¨ï¼Œå¹¶ä¸”åˆå¹¶ç›¸åŒå—ï¼ˆä¸­é—´æ²¡æœ‰å…¶ä»–æ•°å­—çš„é˜»éš”ï¼‰çš„è®¡ç®—é€»è¾‘äº†ã€‚

```dart
GestureDetector(
  onPanUpdate: (DragUpdateDetails details) {
    /// é¦–å…ˆåŒºåˆ†æ˜¯å‚ç›´æ–¹å‘è¿˜æ˜¯æ°´å¹³æ–¹å‘æ»‘åŠ¨
    if (horizontalSwipe) {
      // æ°´å¹³æ–¹å‘æ»‘åŠ¨
      if (_firstValidPan) {
        debugPrint("æ°´å¹³æ–¹å‘æ»‘åŠ¨");
        /// ç„¶ååŒºåˆ†æ˜¯å‘å·¦æ»‘è¿˜æ˜¯å‘å³æ»‘
        if (currentPosition.dx - lastPosition.dx < 0) {
          // å‘å·¦æ»‘
          debugPrint("å‘å·¦æ»‘");
          setState(() {
            /// åˆå¹¶ç›¸åŒçš„å—ï¼Œç§»åŠ¨é0çš„å—åˆ°æœ€å·¦è¾¹
            _joinGameMapDataToLeft();
            if (!_noMoveInSwipe) {
              _randomNewCellData(2);
            }
            _checkGameState();
          });
        }
        _firstValidPan = false;
      }
    } else {
      /// çœç•¥éƒ¨åˆ†ä»£ç 
    }
  },
}
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œåˆ¤æ–­å‡ºå‘å·¦æ»‘åŠ¨åï¼Œè°ƒç”¨äº† `_joinGameMapDataToLeft` æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­å°±æ˜¯åˆå¹¶å’Œç§»åŠ¨çš„é€»è¾‘ï¼ŒåŒæ ·çš„ï¼Œå…¶ä»–æ–¹å‘è¿˜æœ‰ `_joinGameMapDataToRight`ã€`_joinGameMapDataToTop`ã€`_joinGameMapDataToBottom` çš„æ–¹æ³•ã€‚

è¿™é‡Œæˆ‘çš„åˆå¹¶å’Œç§»åŠ¨ç®—æ³•æ¯”è¾ƒæŒ«ï¼Œè‚¯å®šæœ‰æ›´ç®€å•ï¼Œå¤æ‚åº¦æ›´ä½çš„ç®—æ³•æ¥å®ç°ã€‚ä»¥å‘å·¦æ»‘åŠ¨ä¸ºä¾‹ï¼Œæ¥çœ‹çœ‹åˆå¹¶å’Œç§»åŠ¨çš„ç®—æ³•ï¼Œå…¶ä»–æ–¹å‘åŒç†ï¼š

```dart
void _joinGameMapDataToLeft() {
  /// å¼€å§‹æ”¹å˜mapä¸­çš„æ•°æ®æ—¶ï¼Œå…ˆå°†noMoveInSwipeç½®ä¸ºtrue
  _noMoveInSwipe = true;
  /// æ¯ä¸€è¡Œéƒ½è¦è®¡ç®—ï¼Œæ‰€ä»¥ç”¨ for å¾ªç¯éå†æ¯ä¸€è¡Œ
  for (int i = 0; i < SIZE; i++) {
    int j1 = 0;
    while (j1 < SIZE - 1) {
      if (_gameMap[i][j1] == 0) {
        j1++;
        continue;
      }
      for (int j2 = j1 + 1; j2 < SIZE; j2++) {
        if (_gameMap[i][j2] == 0) {
          continue;
        } else if (_gameMap[i][j2] != _gameMap[i][j1]) {
          break;
        } else {
          _gameMap[i][j1] = 2 * _gameMap[i][j1];
          _gameMap[i][j2] = 0;

          /// åœ¨è¿™é‡Œæœ‰ä¸¤ä¸ªå—çš„åˆå¹¶ï¼Œå¢åŠ åˆ†æ•°
          _currentScore += (_gameMap[i][j1] as int);

          /// æŠŠåˆ†æ•°å›è°ƒç»™å¤–ç•Œ
          widget.onScoreChanged?.call(_currentScore);

          /// è¿™è¡Œè¦å†™åœ¨è®°å½•scoreä¹‹åï¼Œä¸ç„¶gameMap[i][j1]å®é™…æ˜¯gameMap[i][j2]ï¼Œå°±æ˜¯0äº†
          j1 = j2;

          /// æœ‰å—çš„åˆå¹¶ï¼Œè¯´æ˜æœ‰ç§»åŠ¨
          _noMoveInSwipe = false;
        }
      }
      j1++;
    }
    int notZeroCount = 0;
    for (int k = 0; k < SIZE; k++) {
      if (_gameMap[i][k] != 0) {
        if (k != notZeroCount) {
          _gameMap[i][notZeroCount] = _gameMap[i][k];
          _gameMap[i][k] = 0;

          /// æœ‰é0æ•°å­—å’Œ0äº¤æ¢ï¼Œè¯´æ˜æœ‰ç§»åŠ¨
          _noMoveInSwipe = false;
        }
        notZeroCount++;
      }
    }
  }
}
```

åˆå¹¶ç›¸åŒçš„é 0 æ•°å­—ï¼šæ¯ä¸€è¡Œéƒ½éœ€è¦è®¡ç®—ï¼Œæ‰€ä»¥ç”¨äº†ä¸€ä¸ª for å¾ªç¯ã€‚åœ¨ä¸€è¡Œçš„è®¡ç®—ä¸­ï¼Œå®šä¹‰äº† j1ã€j2 ä¸¤ä¸ªä¸‹æ ‡ï¼ŒæŒ‡å‘è¦æ¯”è¾ƒæ•°å€¼ç›¸åŒçš„å‰åä¸¤ä¸ªå—ï¼Œj1 Â çš„èŒƒå›´æ˜¯ [0, SIZE -1)ï¼Œå¦‚æœ j1 æ‰€æŒ‡å‘çš„å—æ˜¯0ï¼Œåˆ™è·³åˆ°ä¸‹ä¸€ä¸ªå—ã€‚j2 çš„èŒƒå›´æ˜¯ [j1 + 1, SIZE)ï¼Œå¦‚æœ j2 æ‰€æŒ‡å‘çš„å—æ˜¯ 0ï¼Œåˆ™è·³åˆ°ä¸‹ä¸€ä¸ªå—ï¼›å¦‚æœä¸æ˜¯ 0 ä½†æ˜¯ä¸ç­‰äº j1 æ‰€æŒ‡çš„å—ï¼Œåˆ™è¯´æ˜ j1 å—ä¸å’Œåé¢çš„å—æ•°å­—ç›¸ç­‰ï¼Œæ— æ³•åˆå¹¶ï¼Œç›´æ¥è·³å‡ºå†…å±‚å¾ªç¯ï¼Œè®© j1 ç§»åˆ°ä¸‹ä¸€ä¸ªï¼›å¦åˆ™å°±æ˜¯ j2 æ‰€åœ¨çš„å—å’Œ j1 æ‰€åœ¨çš„å—æ•°å­—ç›¸åŒï¼Œè¿™æ—¶å€™å°±æŠŠè¿™ä¸¤ä¸ªå—åˆå¹¶ï¼Œj1 æ‰€åœ¨å—æ•°å­—å˜ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œj2 æ‰€åœ¨å—å˜ä¸º 0ï¼Œå¹¶ä¸”è®© j1 ç›´æ¥ç§»åˆ° j2 å¤„ï¼Œä¸‹ä¸€æ¬¡çš„å¤–å±‚å¾ªç¯å°±ä» j2 + 1 å¤„ç»§ç»­ã€‚

ç§»åŠ¨é 0 æ•°å­—åˆ°æœ€å·¦ä¾§ï¼šå®šä¹‰äº†ä¸€ä¸ªå˜é‡ `notZeroCount`ï¼Œ**ä»£è¡¨éå†åˆ°çš„é 0 æ•°å­—çš„ä¸ªæ•°ï¼Œå…¶å®å®ƒä¹Ÿè¡¨ç¤ºç¬¬ nï¼ˆn ä» 0 å¼€å§‹ï¼‰ ä¸ªé 0 æ•°å­—åº”è¯¥æ”¾ç½®çš„ä¸‹æ ‡**ã€‚æ¸¸æ ‡ k èŒƒå›´æ˜¯ [0, SIZE)ï¼Œä¾æ¬¡é€’å¢ï¼Œå¦‚æœé‡åˆ°é 0 æ•°å­—ï¼Œéœ€è¦æ¯”è¾ƒ k å’Œ notZeroCountï¼Œå¦‚æœä¸¤è€…ç›¸åŒï¼Œè¯´æ˜è¿™ä¸ªé 0 æ•°å­—å·²ç»æ”¾åœ¨äº†æ­£ç¡®çš„ä½ç½®ï¼Œä¸éœ€è¦ç§»åŠ¨äº†ï¼›å¦‚æœä¸ç›¸ç­‰ï¼Œè¯´æ˜ä¹‹å‰éå†è¿‡æ•°å­—ä¸º 0 çš„å—ï¼Œè¿™æ—¶å€™è¿™ä¸ªé 0 æ•°å­—åº”è¯¥è¢«æ”¾åœ¨ä¸‹æ ‡ä¸º notZeroCount çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ä¸‹æ ‡ä¸º k çš„ä½ç½®ï¼Œéœ€è¦å°†ä¸¤ä¸ªä½ç½®çš„æ•°å­—äº¤æ¢ã€‚notZeroCount åœ¨é‡åˆ°é 0 æ•°å­—çš„å—åä¼šè‡ªå¢ã€‚

ä¸‹é¢çš„å›¾ç‰‡æ¼”ç¤ºäº†ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹ï¼Œè¯»è€…å¯ä»¥å¯¹ç…§ç€ä»£ç è¿›è¡Œç†è§£ã€‚

![](https://s2.loli.net/2022/05/24/so51dluAHbLTqGi.png#crop=0&crop=0&crop=1&crop=1&height=637&id=eIIcx&originHeight=1273&originWidth=2089&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1045)

å®Œæˆè¿™ä¸€æ­¥ï¼Œæ£‹ç›˜ä¸­çš„å°æ ¼å­å°±å¯ä»¥åœ¨æ£‹ç›˜ä¸­ä¸Šä¸‹å·¦å³ç§»åŠ¨äº†ã€‚åˆ°è¿™ä¸€æ­¥è¿è¡Œèµ·æ¥çš„æ•ˆæœå¦‚ä¸‹ï¼š

![](https://s2.loli.net/2022/05/24/vkFHOe519q7SzQp.gif#crop=0&crop=0&crop=1&crop=1&height=640&id=rBEOC&originHeight=1280&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=288)

ä¸è¿‡æˆ‘ä»¬è¿˜æ²¡æœ‰æ–°çš„æ•°å­—å—äº§ç”Ÿï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥è‡ªç„¶æ˜¯åœ¨æ»‘åŠ¨åäº§ç”Ÿæ–°çš„æ•°å­—å—ã€‚

#### äº§ç”Ÿæ–°çš„æ•°å­—å—

å¦‚æœä¸€æ¬¡æ»‘åŠ¨ï¼Œæœ‰å—çš„ç§»åŠ¨æˆ–åˆå¹¶ï¼Œåˆ™åœ¨ç§»åŠ¨æˆ–åˆå¹¶å®Œåï¼Œéœ€è¦åœ¨ç©ºçš„å—é‡Œéšæœºå†äº§ç”Ÿä¸€ä¸ªæ•°å­—ï¼Œå¦‚æœæ—¢æ²¡æœ‰å—çš„ç§»åŠ¨ä¹Ÿæ²¡æœ‰å—çš„åˆå¹¶ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„æ•°å­—å—ã€‚é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª bool ç±»å‹çš„å˜é‡ `_noMoveInSwipe`ï¼Œä»£è¡¨ä¸€æ¬¡æ»‘åŠ¨ä¸­æœ‰æ²¡æœ‰å—çš„ç§»åŠ¨ï¼Œå—çš„ç§»åŠ¨åŒ…å«ä¸¤ç§æƒ…å†µï¼šå—çš„åˆå¹¶å’Œé 0 å—ç§»åˆ°æœ€å·¦è¾¹ã€‚å›åˆ°ä¸Šé¢çš„ä»£ç ï¼Œåœ¨ `_joinGameMapDataToLeft` ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œéƒ½ä¼šå°† _noMoveInSwipe ç½®ä¸º trueï¼Œåœ¨å—çš„åˆå¹¶æ—¶å’Œå—çš„ç§»åŠ¨äº¤æ¢æ—¶ï¼Œç»™è¿™ä¸ªå˜é‡è®¾ä¸º falseã€‚ç„¶ååœ¨ _`__joinGameMapDataToLeft_`_ ä¹‹ååˆ¤æ–­å¦‚æœ _noMoveInSwipe ä¸º falseï¼Œåˆ™è°ƒç”¨ `_randomNewCellData(2)` éšæœºç”Ÿæˆä¸€ä¸ªæ•°å­—ä¸º 2 çš„å—ã€‚

```
/// è¿™ä¸€æ¬¡æ‰‹åŠ¿æ»‘åŠ¨ï¼Œæ˜¯ä¸æ˜¯æ²¡æœ‰å—ç§»åŠ¨ï¼Œå¦‚æœæ²¡æœ‰å—ç§»åŠ¨ï¼Œå°±ä¸èƒ½äº§ç”Ÿæ–°çš„å—
bool _noMoveInSwipe = true;
```

![](https://s2.loli.net/2022/05/24/gNhYiRUEc6oFKlP.png#crop=0&crop=0&crop=1&crop=1&height=598&id=dgtHY&originHeight=814&originWidth=817&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600)

![](https://s2.loli.net/2022/05/24/gYMQibdNkF78wHc.png#crop=0&crop=0&crop=1&crop=1&height=271&id=y6Sv6&originHeight=363&originWidth=804&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600)

![](https://s2.loli.net/2022/05/24/PmhKJIYwT5QXu2k.png#crop=0&crop=0&crop=1&crop=1&height=320&id=nWZyJ&originHeight=313&originWidth=586&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600)

è¿™æ­¥å®Œæˆåï¼Œå…¶å® 2048 çš„ä¸»ä½“åŠŸèƒ½å°±å®Œæˆäº†ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥å¼€å§‹ä¸æ–­æ»‘åŠ¨æ¥åˆå¹¶æ•°å­—å—äº†ã€‚æ¼”ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š

![](https://s2.loli.net/2022/05/24/qvYtwE6oR17C4j3.gif#crop=0&crop=0&crop=1&crop=1&height=640&id=yMx3L&originHeight=1280&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=288)

#### æ›´æ–°åˆ†æ•°

æ¸¸æˆæ²¡æœ‰åˆ†æ•°å°±å°‘äº†å¾ˆå¤šä¹è¶£ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™å®ƒåŠ ä¸Šè®°åˆ†æœºåˆ¶ã€‚å½“æœ‰ä¸¤ä¸ªå—åˆå¹¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°å½“å‰çš„åˆ†æ•°ï¼Œåœ¨å½“å‰åˆ†æ•°ä¸ŠåŠ ä¸Šåˆå¹¶åçš„æ•°å€¼ã€‚å› ä¸ºè¿™ä¸ªåˆ†æ•°çš„æ•°å­—å¹¶ä¸æ˜¯æ˜¾ç¤ºåœ¨ Game2048Panel é‡Œé¢ï¼Œè€Œæ˜¯æ˜¾ç¤ºåœ¨ Game2048Page çš„ Header éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ç§æ–¹å¼å°†æœ€æ–°çš„åˆ†æ•°ä¼ é€’ç»™ Game2048Pageã€‚è¿™é‡Œæˆ‘ä»¬ç»™ Game2048Panel æ·»åŠ ä¸€ä¸ª `onScoreChanged` çš„å›è°ƒï¼Œå¯ä»¥åœ¨æ•°å­—å—åˆå¹¶åæŠŠå˜åŒ–åçš„åˆ†æ•°ä¼ ç»™çˆ¶å®¹å™¨ã€‚

```dart
class Game2048PanelTest extends StatefulWidget {
  /// åˆ†æ•°å˜åŒ–çš„å›è°ƒ
  final ValueChanged<int>? onScoreChanged;

  Game2048PanelTest({Key? key, this.onScoreChanged}) : super(key: key);
}
```

![](https://s2.loli.net/2022/05/24/dA2nBWZxi5fmLXk.png#crop=0&crop=0&crop=1&crop=1&id=L5viP&originHeight=661&originWidth=827&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

åœ¨çˆ¶å®¹å™¨ Game2048Page ä¸­ï¼Œé¦–å…ˆå£°æ˜äº†ä¸¤ä¸ªçŠ¶æ€å˜é‡ï¼Œ`currentScore` å’Œ `highestScore`ï¼Œå¦å¤–åœ¨ Game2048Panel çš„ onScoreChanged å›è°ƒé‡Œï¼Œç»™ currentScore èµ‹å€¼ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦å¤§äº highestScoreï¼Œå¦‚æœå¤§äºï¼Œå°† currentScore çš„å€¼èµ‹ç»™ highestScore å¹¶æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œæ¥ç€åˆ·æ–°ç•Œé¢ã€‚

```dart
/// å½“å‰åˆ†æ•°
int currentScore = 0;
/// å†å²æœ€é«˜åˆ†
int highestScore = 0;

Column(
  children: [
    Flexible(child: gameHeader()),
    Flexible(flex: 2,child: Game2048Panel(
    	key: _gamePanelKey,
      onScoreChanged: (score) {
        setState(() {
          currentScore = score;
          if (currentScore > highestScore) {
            highestScore = currentScore;
            storeHighestScoreToSp();
          }
        });
      },
      )
    )
  ],
)
```

![](https://s2.loli.net/2022/05/24/4esEvRHt7KhW2AO.gif#crop=0&crop=0&crop=1&crop=1&height=640&id=BOx8b&originHeight=1280&originWidth=576&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=288)

ä¿å­˜å†å²æœ€é«˜åˆ†æ•°ç”¨åˆ°äº† `shared_preferences` è¿™ä¸ªæ’ä»¶æ¥ä¿å­˜æ•°æ®ï¼Œå®ƒå¯ä»¥ä¿å­˜ Key-Value æ ¼å¼çš„æ•°æ®ï¼Œè¿™é‡Œä¸å…·ä½“å±•å¼€ï¼Œçœ‹çœ‹ä»£ç çš„å®ç°ï¼š

```dart
Future<SharedPreferences> _spFuture = SharedPreferences.getInstance();

void readHighestScoreFromSp() async {
  final SharedPreferences sp = await _spFuture;
  setState(() {
    highestScore = sp.getInt(GAME_2048_HIGHEST_SCORE) ?? 0;
  });
}
```

åœ¨è¿›å…¥æ¸¸æˆç•Œé¢æ—¶ï¼Œéœ€è¦ä» SP ä¸­å°†å†å²æœ€é«˜åˆ†æ•°è¯»å–å‡ºæ¥ï¼Œå±•ç¤ºåœ¨ Header é‡Œï¼Œåœ¨ `initState` æ–¹æ³•ä¸­è°ƒç”¨ `readHighestScoreFromSp` æ–¹æ³•ã€‚

```dart
@override
void initState() {
  super.initState();
  readHighestScoreFromSp();
}

void readHighestScoreFromSp() async {
  final SharedPreferences sp = await _spFuture;
  setState(() {
    highestScore = sp.getInt(GAME_2048_HIGHEST_SCORE) ?? 0;
  });
}
```

#### åˆ¤æ–­æ¸¸æˆç»“æŸ

æ¯æ¬¡æ‰‹æŒ‡æ»‘åŠ¨ï¼Œç§»åŠ¨ / åˆå¹¶äº†å—ï¼Œäº§ç”Ÿäº†æ–°çš„æ•°å­—å—åï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ£€æŸ¥ä¸€ä¸‹æ¸¸æˆæ˜¯å¦ç»“æŸã€‚å†™ä¸€ä¸ª `_checkGameState` çš„æ–¹æ³•ï¼Œå½“ _gameMap ä¸­æ‰€æœ‰çš„æ•°å­—éƒ½ä¸ä¸º Â 0 æ—¶ï¼Œå¼€å§‹æ£€æŸ¥æ¨ªçºµæ–¹å‘ä¸Šæ˜¯å¦å­˜åœ¨å¯ä»¥åˆå¹¶çš„æ•°å­—ï¼Œå¦‚æœéƒ½æ²¡æœ‰ï¼Œåˆ™ä»£è¡¨æ¸¸æˆç»“æŸï¼Œå¦‚æœæœ‰å¯ä»¥åˆå¹¶çš„ï¼Œåˆ™æ¸¸æˆæ²¡æœ‰ç»“æŸã€‚

```dart
void _checkGameState() {
  if (!isGameMapAllNotZero()) {
    return;
  }
  /// å¦‚æœ Map ä¸­æ•°å­—éƒ½ä¸ä¸º0ï¼Œåˆ™éœ€è¦åˆ¤æ–­æ¨ªçºµæ–¹å‘ä¸Šæ˜¯å¦å­˜åœ¨å¯ä»¥åˆå¹¶çš„æ•°å­—ï¼Œ
  /// å¦‚æœæœ‰ï¼Œåˆ™æ¸¸æˆä¸ç®—ç»“æŸï¼Œéƒ½æ²¡æœ‰çš„è¯ï¼Œæ¸¸æˆç»“æŸ
  bool canMerge = false;
  for (int i = 0; i< SIZE; i++) {
    for (int j = 0; j< SIZE  - 1; j++) {
      if (_gameMap[i][j] == _gameMap[i][j + 1]) {
        canMerge = true;
        break;
      }
    }
    if (canMerge) {
      break;
    }
  }
  for (int j = 0; j < SIZE; j++) {
    for (int i = 0; i < SIZE  - 1; i++) {
      if (_gameMap[i][j] == _gameMap[i + 1][j]) {
        canMerge = true;
        break;
      }
    }
    if (canMerge) {
      break;
    }
  }
  // æ¨ªçºµéå†å®Œåï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥åˆå¹¶çš„ï¼Œæ¸¸æˆç»“æŸ
  if (!canMerge) {
    setState(() {
      _isGameOver = true;
    });
  }
}
```

![](https://s2.loli.net/2022/05/24/QdqHaJomtVrw9Ej.jpg#crop=0&crop=0&crop=1&crop=1&height=559&id=wDbK3&originHeight=2235&originWidth=1080&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=270)

#### é‡æ–°å¼€å§‹æ¸¸æˆ

ä¸è¦å¿˜äº†æˆ‘ä»¬è¿˜æœ‰ä¸¤ä¸ªåœ°æ–¹å¯ä»¥è§¦å‘é‡æ–°å¼€å§‹æ¸¸æˆï¼Œä¸€ä¸ªæ˜¯ Header éƒ¨åˆ†çš„ New Game æŒ‰é’®ï¼Œä¸€ä¸ªæ˜¯æ¸¸æˆç»“æŸè’™å±‚ä¸Šçš„ Restart æŒ‰çº½ã€‚å®ç°é‡æ–°å¼€å§‹æ¸¸æˆçš„é€»è¾‘å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å°† `_gameMap` çš„æ•°æ®å…¨éƒ¨æ¸…ç©ºï¼Œåˆå§‹åŒ–ä¸€æ¬¡æ¸¸æˆæ•°æ®ï¼Œå¹¶ä¸”é‡ç½®ä¸€äº›çŠ¶æ€ï¼Œæ¯”å¦‚å½“å‰çš„åˆ†æ•°å’Œæ˜¯å¦æ¸¸æˆç»“æŸçš„çŠ¶æ€ï¼Œç„¶ååˆ·æ–°ç•Œé¢å°±å¯ä»¥äº†ã€‚

```dart
void reStartGame() {
  setState(() {
    _resetGameMap();
    _initGameMap();
    // æ¸…ç©ºåˆ†æ•°
    _currentScore = 0;
    // å°†åˆ†æ•°å›è°ƒç»™çˆ¶å®¹å™¨
    widget.onScoreChanged?.call(_currentScore);
    // é‡ç½®æ¸¸æˆçŠ¶æ€ï¼Œæ¸¸æˆæ²¡æœ‰ç»“æŸï¼Œä¸ä¼šå‡ºç°è’™å±‚
    _isGameOver = false;
  });
}

/// æ¸…ç©ºæ¸¸æˆæ•°æ®æºï¼Œå…¨éƒ¨ç½®ä¸º 0
void _resetGameMap() {
  for (int i = 0; i < SIZE; i++) {
    for (int j = 0; j < SIZE; j++) {
      _gameMap[i][j] = 0;
    }
  }
}
```

Restart æŒ‰é’®æ˜¯åœ¨ Game2048PanelState å†…éƒ¨ï¼Œæ‰€ä»¥åœ¨ç‚¹å‡»äº‹ä»¶ä¸­ç›´æ¥è°ƒç”¨ `reStartGame` æ–¹æ³•å³å¯ï¼Œä½† New Game æŒ‰é’®æ˜¯åœ¨ Game2048Page çš„ Header éƒ¨åˆ†ï¼Œä¸åœ¨ Game2018PanelState å†…éƒ¨ï¼Œé‚£è¯¥æ€ä¹ˆè°ƒç”¨åˆ°è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ Global Keyï¼Œæˆ‘ä»¬åœ¨ Game2048Page ä¸­å£°æ˜ä¸€ä¸ªèŒƒå‹ä¸º Game2018PanelState çš„ GlobalKeyï¼Œå¹¶å°†è¿™ä¸ª GlobalKey ä¼ ç»™ Game2048Panel çš„ key å±æ€§ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ Header çš„æŒ‰é’®ä¸­è·å–åˆ° Game2018PanelState çš„å®ä¾‹å¹¶ä¸”è°ƒç”¨å®ƒçš„å…¬å¼€æ–¹æ³•äº†ã€‚

> è¿™é‡Œè¦æ³¨æ„ï¼ŒGame2018PanelState ç°åœ¨æ˜¯å¯ä»¥è¢«å¤–ç•Œè®¿é—®çš„äº†ï¼Œæ‰€ä»¥ä¸èƒ½æš´éœ²çš„å˜é‡å’Œæ–¹æ³•éƒ½è¦å£°æ˜æˆç§æœ‰çš„ï¼Œå˜é‡åå’Œæ–¹æ³•æ˜å‰é¢åŠ ä¸Š `_`ã€‚


```dart
/// ç”¨äºè·å– Game2048PanelState å®ä¾‹ï¼Œä»¥ä¾¿å¯ä»¥è°ƒç”¨restartGameæ–¹æ³•
GlobalKey _gamePanelKey = GlobalKey<Game2048PanelTestState>();

/// New Game æŒ‰é’®
InkWell(
  onTap: () {
    (_gamePanelKey.currentState as Game2048PanelState).reStartGame();
  },
  child: Text("NEW GAME"),
),
```

#### æœ€åä¸€ç‚¹ç»†èŠ‚ï¼šæ¨ªç«–å±é€‚é…

æœ€åçš„æœ€åï¼Œæˆ‘ä»¬æ¥å®Œå–„ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå°±æ˜¯æ¨ªç«–å±çš„é€‚é…ã€‚å‰é¢æåˆ°ï¼ŒHeader éƒ¨åˆ†å’Œ Panel çš„æ¯”ä¾‹æ˜¯ 1 ï¼š2ï¼Œä¸ºä»€ä¹ˆè¦å®šä¸€ä¸ªæ¯”ä¾‹å‘¢ï¼Œå°±æ˜¯ä¸ºäº†é€‚é…æ¨ªç«–å±çš„æƒ…å†µã€‚Flutter ä¸­ï¼Œå¯ä»¥é€šè¿‡ `OrientationBuilder` åˆ¤æ–­å‡ºæ˜¯æ¨ªå±è¿˜æ˜¯ç«–å±ã€‚åœ¨ç«–å±æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ Column ç»„ä»¶ï¼ŒHeader åœ¨ä¸Šæ–¹å ä¸‰åˆ†ä¹‹ä¸€é«˜åº¦ï¼ŒPanel åœ¨ä¸‹æ–¹å ä¸‰åˆ†ä¹‹äºŒçš„é«˜åº¦ã€‚æ¨ªå±æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Row ç»„ä»¶ï¼ŒHeader åœ¨å·¦è¾¹å ä¸‰åˆ†ä¹‹ä¸€å®½åº¦ï¼ŒPanel åœ¨å³æ–¹å ä¸‰åˆ†ä¹‹äºŒçš„å®½åº¦ã€‚è¿™æ ·ä¸€ä¸ªç®€å•çš„æ¨ªç«–å±é€‚é…å°±å®Œæˆäº†ã€‚

```dart
Container(
  padding: EdgeInsets.only(top: 30),
  color: GameColors.bgColor1,
  child: OrientationBuilder(
    builder: (context, orientation) {
      if (orientation == Orientation.portrait) {  // ç«–å±
        return Column(
          children: [
            Flexible(child: gameHeader()),
            Flexible(flex: 2,child: gamePanel)
          ],
        );
      } else {  // æ¨ªå±
        return Row(
          children: [
            Flexible(child: gameHeader()),
            Flexible(flex: 2,child: gamePanel)
          ],
        );
      }
    },
  ),
),
```

æ¨ªå±ä¸‹æ•ˆæœå¦‚å›¾ï¼š

![](https://s2.loli.net/2022/05/24/zsDxwH4CLFjSJl7.jpg#crop=0&crop=0&crop=1&crop=1&height=270&id=Btdsu&originHeight=1080&originWidth=2400&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600)

### ç»“è¯­

åˆ°è¿™é‡Œè¿™ä¸ª Flutter ç‰ˆçš„ 2048 å°æ¸¸æˆå°±åˆ¶ä½œå®Œæˆå•¦ï¼Œè¾¹å­¦è¾¹ç©ä¹Ÿæ˜¯å¾ˆæœ‰è¶£çš„ä½“éªŒã€‚ç®€å•æ€»ç»“ä¸‹è¿™ä¸ªå°é¡¹ç›®æ¶‰åŠçš„ä¸€äº›å°çŸ¥è¯†ç‚¹ï¼š

- AspectRatioã€OrientationBuilderã€GridView ç­‰ Widget çš„ä½¿ç”¨
- Flutter çš„æ‰‹åŠ¿è¯†åˆ«
- è·¨ç»„ä»¶ä¼ é€’çŠ¶æ€å’Œè°ƒç”¨å…¶ä»–ç»„ä»¶çš„å…¬å¼€æ–¹æ³•

ç¥å¤§å®¶å­¦ä¹ æ„‰å¿«ã€‚
